# Приложение ExploreWithMe

Оно позволяет пользователям делиться информацией об интересных событиях и находить компанию для участия в них.

## Custom feature: Comments

### Общее описание

Выбранная дополнительная фича - комментарии.

Добавляется новая функциональность, связанная с возможностью комментирования событий.
Комментарии привязаны к определенному событию.

Комментировать можно только опубликованные события, для предотвращения накрутки количества комментариев,
добавлять комментарии можно только для чужих событий.

Уровни доступа:

- PUBLIC
    * Просмотр комментариев
- PRIVATE
    * Добавление комментария к событию
    * Редактирование комментария
    * Удаление комментария
    * Получение всех своих комментариев
- ADMIN
    * Получение списка новых комментариев
    * Подтверждение публикации комментария
    * Удаление комментария любого пользователя
    

### Модель данных

Комментарий содержит следующие атрибуты:

* id комментария
* id пользователя, который добавляет комментарий
* id комментируемого события
* текст комментария
* дата создания комментария  (в формате "yyyy-MM-dd HH:mm:ss")
* дата публикации комментария  (в формате "yyyy-MM-dd HH:mm:ss")
* статус комментария (новый, опубликованный, отклоненный)


Статус комментария может быть:
* NEW - новый, при создании комментария
* PUBLISHED - опубликованный, после успешного прохождения модерации
* REJECTED - отклоненный, после отклонения модератором

_______________________________________________________

## PUBLIC endpoints

### GET /events/{eventId}/comments

Получение комментариев к определенному событию:
* Комментарии показываются только если они опубликованы
* Комментарии должны быть отсортированы от более новых к более старым
* Должна быть реализована настраиваемая пагинация

Так как это публичная часть API и внутренний процесс модерации не виден, поля created и status не передаются. 
При отсутствии комментариев должен возвращаться пустой список.

#### Параметры

PATH PARAMETERS

* __eventId__ (required) integer (int64) - id события, комментарии к которому запрашиваются

QUERY PARAMETERS

* __from__ (integer, >= 0, Default: 0) - количество элементов, которые нужно пропустить для формирования текущего набора
* __size__ (integer, Default: 10) - количество элементов в наборе

#### Пример ответа

```json
[
  {
    "id": 123,
    "commentator": 12,
    "event": 45,
    "comment": "This is second comment",
    "published": "2025-07-21 17:12:45"
  },
  {
    "id": 12,
    "commentator": 11,
    "event": 45,
    "comment": "This is first comment",
    "published": "2025-07-20 11:12:41"
  }
]
```

#### Статусы ответов

* 200 - Успешный ответ на запрос
* 400 - Запрос некорректный 
* 404 - Событие не найдено

_______________________________________________________

## PRIVATE endpoints

### POST /events/{eventId}/comments

Добавление комментария к событию:
* комментарий может быть только к опубликованному событию (EventState.PUBLISHED)
* комментарий может быть только к чужому событию
* при обработке текста комментария должен применяться trim

#### Параметры

HEADERS

* __X-EWM-User-Id__ (integer (int64) userId) - id пользователя

PATH PARAMETERS

* __eventId__ (required) integer (int64) - id комментируемого события

REQUEST BODY SCHEMA: application/json

Данные добавляемого комментария

* __comment__  (required) string [1 .. 2000] characters - текст комментария

#### Пример запроса

```json
{
  "comment": "This is test comment"
}
```

#### Пример ответа

```json
{
  "id": 123,
  "commentator": 12,
  "event": 45,
  "comment": "This is test comment",
  "created": "2025-07-21 15:32:00",
  "status": "NEW"
}
```

#### Статусы ответов
* 201 - Комментарий создан
* 400 - Запрос составлен некорректно
* 404 - Событие или пользователь не найдены
* 409 - Комментировать можно только PUBLISHED событие
* 403 - Комментировать можно только чужие события

_______________________________________________________

### PATCH /comments/{commentId}

Редактирование комментария:

* редактировать можно только собственные комментарии
* любое изменение комментария переводит его в статус нового

#### Параметры

HEADERS

* __X-EWM-User-Id__ (integer (int64) userId) - id пользователя

PATH PARAMETERS

* __commentId__ (required) integer (int64) - id редактируемого комментария

REQUEST BODY SCHEMA: application/json

Данные добавляемого комментария

* __comment__  (required) string [1 .. 2000] characters - текст комментария

#### Пример запроса

```json
{
  "comment": "This is new text for test comment"
}
```

#### Пример ответа

```json
{
  "id": 123,
  "commentator": 12,
  "event": 45,
  "comment": "This is new text for test comment",
  "created": "2025-07-21 15:32:00",
  "status": "NEW"
}
```

#### Статусы ответов
* 200 - Комментарий изменен
* 400 - Запрос составлен некорректно
* 404 - Комментарий или пользователь не найдены
* 403 - Редактировать можно только свои комментарии


_______________________________________________________

### DELETE /comments/{commentId}

Удаление комментария:
* удалять можно только свои комментарии
* удаление "жесткое"

#### Параметры

HEADERS

* __X-EWM-User-Id__ (integer (int64) userId) - id пользователя

PATH PARAMETERS

* __commentId__ (required) integer (int64) - id удаляемого комментария


#### Статусы ответов
* 204 - Комментарий удален
* 404 - Комментарий или пользователь не найдены
* 403 - Удалять можно только свои комментарии
_______________________________________________________

### GET /users/comments

Получение всех собственных комментариев пользователя:
* комментарии возвращаются по-умолчанию все, но есть фильтр на любой статус, фильтр работает на 1 значение
* сортировка от более новых к более старым

#### Параметры
HEADERS

* __X-EWM-User-Id__ (integer (int64) userId) - id пользователя


QUERY PARAMETERS
* __filter__ (string, Default: "all") - фильтр комментариев по статусу (new, rejected, published, all)
* __from__ (integer, >= 0, Default: 0) - количество элементов, которые нужно пропустить для формирования текущего набора
* __size__ (integer, Default: 10) - количество элементов в наборе

#### Пример ответа

```json
[
  {
    "id": 123,
    "commentator": 12,
    "event": 45,
    "comment": "This is second comment",
    "created": "2025-07-20 21:11:05",
    "published": "2025-07-21 17:42:45",
    "status": "PUBLISHED"
  },
  {
    "id": 12,
    "commentator": 12,
    "event": 4,
    "comment": "This is first comment",
    "created": "2025-07-20 21:11:05",
    "published": null,
    "status": "NEW"
  }
]
```
#### Статусы ответов
* 200 - Запрос успешно отработан
* 404 - Пользователь не найден

_______________________________________________________

## ADMIN endpoints


### GET admin/comments

Получение новых комментариев всех пользователей ко всем событиям:
* По-умолчанию показываются только новые комментарии, фильтр работает на 1 значение
* Комментарии должны быть отсортированы от более старых к более новым по дате создания
* Должна быть реализована настраиваемая пагинация

При отсутствии комментариев должен возвращаться пустой список.

#### Параметры

QUERY PARAMETERS
* __filter__ (string, Default: "new") - фильтр комментариев по статусу (new, rejected, published, all)
* __from__ (integer, >= 0, Default: 0) - количество элементов, которые нужно пропустить для формирования текущего набора
* __size__ (integer, Default: 10) - количество элементов в наборе


#### Пример ответа

```json
[
  {
    "id": 123,
    "commentator": 12,
    "event": 45,
    "created": "2025-07-27 21:11:05",
    "published": null,
    "status": "NEW"
  },
  {
    "id": 12,
    "commentator": 11,
    "event": 45,
    "created": "2025-07-21 11:01:35",
    "published": null,
    "status": "NEW"
  },
  {
    "id": 112,
    "commentator": 111,
    "event": 4,
    "created": "2025-07-19 11:01:35",
    "published": "2025-07-21 17:42:45",
    "status": "PUBLISHED"
  },
  {
    "id": 13,
    "commentator": 1,
    "event": 5,
    "created": "2025-01-21 11:01:35",
    "published": null,
    "status": "REJECTED"
  }
]
```

#### Статусы ответов

* 200 - Успешный ответ на запрос
* 400 - Запрос некорректный


### PUT /admin/comments/{commentId}?status={approved|rejected}

Подтверждение или отклонение публикации комментария:
* применяется только к новым комментариям 


#### Параметры

PATH PARAMETERS

* __status__ (required) string - новый статус комментария, может быть approved или rejected

#### Статусы ответов
* 202 - Статус изменен
* 400 - Неправильный запрос
* 404 - Комментарий не найден
* 406 - Применимо только к новым комментариям

_______________________________________________________

### DELETE /admin/comments/{commentId}

Удаление комментария пользователя:
* комментарий может быть удален в любом статусе
* удаление "жесткое"

#### Параметры

PATH PARAMETERS

* __commentId__ (required) integer (int64) - id удаляемого комментария


#### Статусы ответов
* 204 - Комментарий удален
* 404 - Комментарий не найден

## Тест-кейсы для фичи Comments

### Описание

Данные тест-кейсы покрывают функционал **комментирования событий** в сервисе **ExploreWithMe**. Фича включает:

- Публичное чтение комментариев.
- Приватное добавление, редактирование и удаление комментариев.
- Административную модерацию и удаление комментариев.

Тесты охватывают позитивные и негативные сценарии, а также проверяют права доступа, ограничения и бизнес-правила.

---

### PUBLIC: `GET /events/{eventId}/comments`

| ID | Описание | Параметры | Ожидаемый статус | Ожидаемый результат |
|----|----------|-----------|------------------|---------------------|
| TC1 | Запрос комментариев к событию с опубликованными комментариями | eventId = 1 | 200 | Список комментариев, отсортированных по дате от новых к старым |
| TC2 | Запрос к событию без комментариев | eventId = 2 | 200 | `[]` |
| TC3 | Запрос к несуществующему событию | eventId = 999 | 404 | - |
| TC4 | Невалидный eventId (строка) | eventId = "abc" | 400 | - |
| TC5 | Пагинация: from=0&size=5 | eventId = 1, from=0, size=5 | 200 | Список из 5 элементов |
| TC6 | Пагинация: from=5&size=5 | eventId = 1, from=5, size=5 | 200 | Следующие 5 элементов |

---

### PRIVATE: `POST /events/{eventId}/comments`

| ID | Описание | Параметры | Ожидаемый статус | Ожидаемый результат |
|----|----------|-----------|------------------|---------------------|
| TC7 | Успешное добавление комментария | eventId = 1, X-EWM-User-Id = 2, comment = "Test comment" | 201 | Комментарий создан, статус NEW |
| TC8 | Комментарий к неопубликованному событию | eventId = 3 (статус не PUBLISHED), X-EWM-User-Id = 2 | 409 | - |
| TC9 | Комментарий к своему событию | eventId = 4 (создатель = X-EWM-User-Id), comment = "Test" | 403 | - |
| TC10 | Комментарий слишком длинный (2001 символ) | comment = "a" * 2001 | 400 | - |
| TC11 | Пустой комментарий | comment = "" | 400 | - |
| TC12 | Несуществующее событие | eventId = 999 | 404 | - |
| TC13 | Несуществующий пользователь | X-EWM-User-Id = 999 | 404 | - |

---

### ️PRIVATE: `PATCH /comments/{commentId}`

| ID | Описание | Параметры | Ожидаемый статус | Ожидаемый результат |
|----|----------|-----------|------------------|---------------------|
| TC14 | Успешное редактирование своего комментария | commentId = 1, X-EWM-User-Id = 2, comment = "New text" | 200 | Поле `comment` обновлено, статус NEW |
| TC15 | Редактирование чужого комментария | commentId = 1, X-EWM-User-Id = 3 | 403 | - |
| TC16 | Несуществующий комментарий | commentId = 999 | 404 | - |
| TC17 | Пустой комментарий | comment = "" | 400 | - |
| TC18 | Несуществующий пользователь | X-EWM-User-Id = 999 | 404 | - |

---

### PRIVATE: `DELETE /comments/{commentId}`

| ID | Описание | Параметры | Ожидаемый статус | Ожидаемый результат |
|----|----------|-----------|------------------|---------------------|
| TC19 | Удаление своего комментария | commentId = 1, X-EWM-User-Id = 2 | 204 | Комментарий удален |
| TC20 | Удаление чужого комментария | commentId = 1, X-EWM-User-Id = 3 | 403 | - |
| TC21 | Несуществующий комментарий | commentId = 999 | 404 | - |
| TC22 | Несуществующий пользователь | X-EWM-User-Id = 999 | 404 | - |

---

###  ADMIN: `GET /admin/comments`

| ID | Описание | Параметры | Ожидаемый статус | Ожидаемый результат |
|----|----------|-----------|------------------|---------------------|
| TC23 | Получить список новых комментариев | filter = new | 200 | Список с NEW |
| TC24 | Получить список опубликованных | filter = published | 200 | Список с PUBLISHED |
| TC25 | Получить все комментарии | filter = all | 200 | Все статусы |
| TC26 | Пагинация: from=0&size=5 | from=0, size=5 | 200 | 5 записей |
| TC27 | Неверный фильтр | filter = invalid | 400 | - |

---

### ADMIN: `PUT /admin/comments/{commentId}?status={approved|rejected}`

| ID | Описание | Параметры | Ожидаемый статус | Ожидаемый результат |
|----|----------|-----------|------------------|---------------------|
| TC28 | Одобрить комментарий | status = approved | 202 | Статус PUBLISHED, published = now |
| TC29 | Отклонить комментарий | status = rejected | 202 | Статус REJECTED |
| TC30 | Применить к не-NEW комментарию | commentId = 2 (PUBLISHED) | 406 | - |
| TC31 | Несуществующий комментарий | commentId = 999 | 404 | - |

---

### ADMIN: `DELETE /admin/comments/{commentId}`

| ID | Описание | Параметры | Ожидаемый статус | Ожидаемый результат |
|----|----------|-----------|------------------|---------------------|
| TC32 | Удаление любого комментария | commentId = 1 | 204 | Комментарий удален |
| TC33 | Несуществующий комментарий | commentId = 999 | 404 | - |

---

### PRIVATE: `GET /users/comments`

| ID | Описание | Параметры | Ожидаемый статус | Ожидаемый результат |
|----|----------|-----------|------------------|---------------------|
| TC34 | Получить все комментарии пользователя | X-EWM-User-Id = 2 | 200 | Список всех комментариев |
| TC35 | Несуществующий пользователь | X-EWM-User-Id = 999 | 404 | - |
